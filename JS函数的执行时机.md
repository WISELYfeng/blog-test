# JS函数的执行时机

2021.2.27

> 何时执行函数将影响执行结果

``` javascript
    let i = 0
    for(i = 0; i<6; i++){
        setTimeout(()=>{
            console.log(i)
        },0)
    }
```

上面一段代码在执行后会打印“6，6，6，6，6，6”而不是“0，1，2，3，4，5”。

这是由于JS引擎执行代码时，会安排代码执行顺序。`i`在for循环之外声明，作用域在外层，当循环进行时，`i`的值多次被修改，而如果不使用`break`、`continue`关键字，循环不会被中断。

即使`setTimeout`的执行时间参数值是0，也不会被执行，那么`setTimeout`什么时候生效？当循环达到退出条件时才执行，连在一起看，时间参数值是0真正的作用是：当循环结束时，立即执行`setTimeout`里的代码。此时取到的`i`值是6，所以会打印6次6而不是“0，1，2，3，4，5”。

如果想打印“0，1，2，3，4，5”，只需要稍微改写代码就可以：

``` javascript
    for(let i = 0; i<6; i++){
        setTimeout(()=>{
            console.log(i)
        },0)
    }
```

还有一种方式，利用闭包 + 立即执行：

``` javascript
    for (var i = 0; i<6;i++){
        (function (j) {
            setTimeout(() => {
                console.log(j)
            },0);

        })(i);
    }
```

上面这段代码的原理是：每当`i`的值发生变化，就将`i`作为参数传给一个立即执行函数，该函数会打印出`i`的值。

在for循环内部定义的匿名函数可以访问到外部作用域的变量，且该匿名函数是立即执行函数，因此，for循环每执行一次，匿名函数也执行一次，即可获取到变化的`i`。
